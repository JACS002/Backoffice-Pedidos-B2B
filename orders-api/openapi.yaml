openapi: 3.0.0
info:
  title: Orders API
  description: API para gestión de productos y órdenes con stock transaccional.
  version: 1.0.0
servers:
  - url: http://localhost:3002
    description: Servidor Local Docker

paths:
  /health:
    get:
      summary: Health Check
      responses:
        "200":
          description: OK

  /products:
    post:
      summary: Crear producto
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                sku:
                  type: string
                name:
                  type: string
                price_cents:
                  type: integer
                stock:
                  type: integer
      responses:
        "201":
          description: Producto creado
    get:
      summary: Buscar productos
      parameters:
        - in: query
          name: search
          schema:
            type: string
      responses:
        "200":
          description: Lista de productos

  /orders:
    post:
      summary: Crear Orden (Transaction)
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                customer_id:
                  type: integer
                items:
                  type: array
                  items:
                    type: object
                    properties:
                      product_id:
                        type: integer
                      qty:
                        type: integer
      responses:
        "201":
          description: Orden creada (Status CREATED)

  /orders/{id}:
    get:
      summary: Obtener orden por ID
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Detalle de orden con items

  /orders/{id}/confirm:
    post:
      summary: Confirmar Orden (Idempotente)
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
        - in: header
          name: X-Idempotency-Key
          required: true
          schema:
            type: string
          description: Clave única para evitar doble procesamiento
      responses:
        "200":
          description: Orden confirmada (o respuesta cacheada si se repite key)

  /orders/{id}/cancel:
    post:
      summary: Cancelar Orden
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Orden cancelada y stock restaurado
